
name: Build & Push React App Image to Docker Hub

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  docker:
    runs-on: ubuntu-latest    # Change to 'ubuntu-latest' if you want GitHub-hosted runners

    permissions:
      contents: read

    env:
      IMAGE_NAME: devenops641/endhunger
      LATEST_TAG: latest

    steps:
      # 1) Checkout source
      - name: Checkout
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      # 2) Quick diagnostics
      - name: Show workspace context
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          pwd
          ls -la
          test -f package.json || (echo "package.json missing" && exit 1)
          test -f Dockerfile || (echo "Dockerfile missing at repo root" && exit 1)

      # 3) Setup Node.js (used to read version from package.json)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 4) Read version from package.json for semantic tags
      - name: Read version
        id: pkg
        run: echo "ver=$(node -p \"require('./package.json').version\")" >> $GITHUB_OUTPUT

      # 5) Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6) Set up Buildx (single-arch build here; ready for multi-arch if needed)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 7) Build image (tags: latest + short SHA)
      - name: Build image
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "Building ${IMAGE_NAME}:${SHORT_SHA} and ${IMAGE_NAME}:${LATEST_TAG}"
          docker build \
            --build-arg PUBLIC_URL=/ \
            -t "${IMAGE_NAME}:${SHORT_SHA}" \
            -t "${IMAGE_NAME}:${LATEST_TAG}" \
            .

      # 8) Push image
      - name: Push image
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          docker push "${IMAGE_NAME}:${SHORT_SHA}"
          docker push "${IMAGE_NAME}:${LATEST_TAG}"

      # 9) Optional: tag with package.json version (e.g., 1.0.3) and push
      - name: Tag & push semantic version
        if: ${{ steps.pkg.outputs.ver != '' }}
        run: |
          VER="${{ steps.pkg.outputs.ver }}"
          echo "Tagging semantic version: ${IMAGE_NAME}:${VER}"
          docker tag "${IMAGE_NAME}:${LATEST_TAG}" "${IMAGE_NAME}:${VER}"
          docker push "${IMAGE_NAME}:${VER}"

      # 10) Verify pull locally
      - name: Verify pull
        run: |
          docker pull "${IMAGE_NAME}:${LATEST_TAG}"
