
name: Deploy React App to Nginx (Self-hosted)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted

    
    env:
      PUBLIC_URL: /

    steps:
      # 1) Checkout repository
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      # 2) Show workspace context (useful when using a self-hosted runner)
      - name: Workspace context
        run: |
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          pwd
          ls -la
          test -f package.json || (echo "package.json not found in current directory" && exit 1)

      # 3) Setup Node.js (adjust version if your app requires different LTS)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 4) Clean old build artifacts
      - name: Clean build artifacts
        run: |
          rm -rf node_modules
          rm -rf build

      # 5) Install dependencies
      - name: Install dependencies
        run: npm ci

      # 6) Build React app (CRA respects PUBLIC_URL)
      - name: Build React app
        run: |
          echo "PUBLIC_URL=$PUBLIC_URL"
          npm run build

      # 7) Inspect build output for assets (helps catch blank-page issues)
      - name: Inspect build output
        run: |
          ls -l build/ || true
          ls -l build/static/js/ || true
          ls -l build/static/css/ || true
          sed -n '1,80p' build/index.html || true

      # 8) Ensure Nginx is installed and running
      - name: Ensure Nginx installed and running
        run: |
          if ! command -v nginx >/dev/null 2>&1; then
            sudo apt update -y
            sudo apt install -y nginx
            sudo systemctl enable nginx
          fi
          sudo systemctl start nginx
          sudo systemctl status nginx --no-pager || true

      # 9) Configure Nginx for React SPA (idempotent)
      - name: Configure Nginx (React SPA)
        run: |
          sudo tee /etc/nginx/sites-available/default >/dev/null <<'NGINX'
          server {
              listen 80 default_server;
              listen [::]:80 default_server;

              root /var/www/html;
              index index.html;

              # React SPA routing: serve index.html for client-side routes
              location / {
                  try_files $uri /index.html;
              }
          }
          NGINX

          sudo ln -sf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default
          sudo nginx -t

      # 10) Deploy build to Nginx webroot
      - name: Deploy build to /var/www/html
        run: |
          # Remove old files
          sudo rm -rf /var/www/html/*

          # Copy contents of build/ into webroot
          sudo rsync -av --delete build/ /var/www/html/

          # Ownership and permissions
          sudo chown -R www-data:www-data /var/www/html
          sudo find /var/www/html -type d -exec chmod 755 {} \;
          sudo find /var/www/html -type f -exec chmod 644 {} \;

          # Restart Nginx
          sudo systemctl restart nginx

      # 11) Post-deploy verification (probes index and assets, tails logs)
      - name: Verify deployment
        run: |
          echo "Listing /var/www/html:"
          ls -l /var/www/html/ || true

          echo "Listing /var/www/html/static/js:"
          ls -l /var/www/html/static/js/ || true

          echo "Listing /var/www/html/static/css:"
          ls -l /var/www/html/static/css/ || true

          echo "index.html head:"
          sed -n '1,80p' /var/www/html/index.html || true

          echo "curl index:"
          curl -I http://localhost || true

          JS1=$(ls /var/www/html/static/js/*.js 2>/dev/null | head -n 1)
          CSS1=$(ls /var/www/html/static/css/*.css 2>/dev/null | head -n 1)

          if [ -n "$JS1" ]; then
            echo "Testing JS asset: $JS1"
            curl -I "http://localhost${JS1#/var/www/html}" || true
          else
            echo "No JS assets found in /var/www/html/static/js/"
          fi

          if [ -n "$CSS1" ]; then
            echo "Testing CSS asset: $CSS1"
            curl -I "http://localhost${CSS1#/var/www/html}" || true
          else
            echo "No CSS assets found in /var/www/html/static/css/"
          fi

          echo "Nginx logs (last 50):"
          sudo tail -n 50 /var/log/nginx/access.log || true
          sudo tail -n 50 /var/log/nginx/error.log || true

      # 12) Completed
      - name: Deployment complete
        run: echo "Application deployed successfully."
