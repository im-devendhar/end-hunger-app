name: Deploying a React App to Nginx (Self-hosted) + Push to Docker Hub

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    env:
      PUBLIC_URL: /
      IMAGE_NAME: devenops641/endhunger
      LATEST_TAG: latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      - name: Workspace context
        run: |
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          pwd
          ls -la
          test -f package.json || (echo "package.json not found" && exit 1)
          test -f Dockerfile || echo "⚠️ Dockerfile not found at repo root (will attempt build if present elsewhere)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Read package version
        id: pkg
        run: |
          # Use node to safely extract version (avoids jq dependency)
          VER=$(node -p "require('./package.json').version" 2>/dev/null || echo "")
          echo "ver=$VER" >> $GITHUB_OUTPUT

      - name: Clean build artifacts
        run: rm -rf node_modules build || true

      - name: Install dependencies
        run: npm ci

      - name: Build React app
        run: |
          echo "PUBLIC_URL=$PUBLIC_URL"
          npm run build

      - name: Inspect build output
        run: |
          ls -l build/ || true
          ls -l build/static/js/ || true
          ls -l build/static/css/ || true
          sed -n '1,80p' build/index.html || true

      - name: Install Docker Engine (if missing)
        run: |
          if ! command -v docker >/dev/null 2>&1; then
            echo "⚙️ Installing Docker..."
            sudo apt update -y
            sudo apt install -y ca-certificates curl gnupg lsb-release
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
              https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
              sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt update -y
            sudo apt install -y docker-ce docker-ce-cli containerd.io
            echo "Docker installed"
          else
            echo "Docker already installed ✔"
          fi

      - name: Fix Docker permissions for runner (socket + group)
        run: |
          # ensure runner user added to docker group (may require restart for full effect)
          sudo usermod -aG docker $USER || true
          # make socket readable/writable so the current process can use docker immediately
          sudo chmod 666 /var/run/docker.sock || true
          echo "User and groups:"
          whoami
          groups
          echo "Quick docker test (may fail if group change not applied but socket chmod helps):"
          docker ps || true

      - name: Build Docker image (tags: short-sha + latest)
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          LATEST_TAG: ${{ env.LATEST_TAG }}
        run: |
          set -e
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "Using Dockerfile at ./Dockerfile"
          echo "Building ${IMAGE_NAME}:${SHORT_SHA} and ${IMAGE_NAME}:${LATEST_TAG}"
          docker build --build-arg PUBLIC_URL="${PUBLIC_URL}" -f ./Dockerfile -t "${IMAGE_NAME}:${SHORT_SHA}" -t "${IMAGE_NAME}:${LATEST_TAG}" .

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push tags to Docker Hub (short-sha + latest)
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          LATEST_TAG: ${{ env.LATEST_TAG }}
        run: |
          set -e
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "Pushing ${IMAGE_NAME}:${SHORT_SHA}"
          docker push "${IMAGE_NAME}:${SHORT_SHA}"
          echo "Pushing ${IMAGE_NAME}:${LATEST_TAG}"
          docker push "${IMAGE_NAME}:${LATEST_TAG}"

      - name: Tag & push semantic version (if package.json has version)
        if: ${{ steps.pkg.outputs.ver != '' }}
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          set -e
          VER="${{ steps.pkg.outputs.ver }}"
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "Tagging ${IMAGE_NAME}:${SHORT_SHA} -> ${IMAGE_NAME}:${VER}"
          docker tag "${IMAGE_NAME}:${SHORT_SHA}" "${IMAGE_NAME}:${VER}"
          docker push "${IMAGE_NAME}:${VER}" || true

      - name: Verify image available in Docker Hub (pull latest)
        run: |
          docker pull "${IMAGE_NAME}:${LATEST_TAG}" || true
          docker images | grep "${IMAGE_NAME}" || true

      - name: Deploy build to /var/www/html (existing flow)
        run: |
          sudo rm -rf /var/www/html/*
          sudo rsync -av --delete build/ /var/www/html/
          sudo chown -R www-data:www-data /var/www/html
          sudo find /var/www/html -type d -exec chmod 755 {} \;
          sudo find /var/www/html -type f -exec chmod 644 {} \;
          sudo systemctl restart nginx

      - name: Verify deployment
        run: |
          echo "Listing /var/www/html:"
          ls -l /var/www/html/ || true
          curl -I http://localhost || true

      - name: Deployment complete
        run: echo "Application deployed successfully and Docker image pushed to Docker Hub."
